# 东宝商城

## 前言

从单体项目到微服务到服务网格的这么一个演化过程

https://gitee.com/cpf100/msb-dongbao-mall

### 意识

意识：

1. 好的技术和架构都是演化来的。杜绝过度设计。
2. 功能先有后优。
3. 好的设计图，架构图，业务逻辑图，时序图等，充满美感
4. 好多牛X的人，都是不断发现自己是傻X的过程。不知道自己不知道，才可怕。
5. 有问题自己先思考再问。（自己没有答案之前不要问）
6. 依赖了别人就是放弃了自己

### 一个项目的流程

企业中怎么做项目？你要去企业中做一个项目，首先是有一个叫产品经理的角色给你需求。但就是给你一份一份产品文档，可能是原型图，可能是一个word。对着需求写好设计文档，写代码的时候照着敲就行。记录好自己开发的思路，哪怕简单的画画几个图，不然自己写的代码过了两周自己都看不懂。

需求出来之后有一个项目的启动会，一般在互联网公司中叫Kick Off。小公司开发和测试可能没有并行，但是大一点的都是开发测试并行的。你写后端开发之前肯定要定义好接口，定好了才去开发，然后测试对着你的接口写测试用例。

开发开始了，做设计，设计完了编码，还有一轮评审。测试也写它的TC。然后测试没问题了才发布。

<img src="image/01.jpg" alt="01" style="zoom: 80%;" />

### 规范

开发规范，阿里规约，命名、日志、错误码、数据库建表等等的规定。

### 工程结构

项目结构是用maven的一个聚合工程。父项目下面是子项目

```xml
父项目
----子项目
----子项目

pom.xml
```

父项目一般以parent结尾。下面有很多子项目，应用入口、接口、实现、工具。

```xml
wcx-dongbao-mall-parent        	父项目
--wcx-dongbao-mall-application 	入口（controller）
--wcx-dongbao-mall-api			接口（controller调用api）
	--wcx-dongbao-cms-api
	--wcx-dongbao-cart-api		购物车api代码
    --wcx-dongbao-pms-api		商品中心api代码
	--wcx-dongbao-dictionary-api
	--wcx-dongbao-oms-api
	--wcx-dongbao-pay-api
	--wcx-dongbao-sms-api
	--wcx-dongbao-ums-api

--wcx-dongbao-mall-service		接口的实现层(api的实现层)
	--xxxx项目
--wcx-dongbao-mall-common		通用工具类

pom.xml
```



创建一个maven项目，写好groupID，看下面规范。

```
1.【强制】定义 GAV 遵从以下规则：
1） GroupID 格式：com.{公司/BU }.业务线 [.子业务线]，最多 4 级。
说明：{公司/BU} 例如：alibaba/taobao/tmall/aliexpress 等 BU 一级；子业务线可选。
正例：com.taobao.jstorm 或 com.alibaba.dubbo.register
```

| ![image-20230422210512975](image/image-20230422210512975.png) |      |
| ------------------------------------------------------------ | ---- |

进来之后pom文件中，由于是父项目，不打成jar或者war。我们这里写pom。

<img src="image/image-20230422210816200.png" alt="image-20230422210816200" style="zoom:67%;" />

然后去创建这个父项目的子项目。父项目通过modules标签来管理它下面的所有的模块，要作为父的模块，就在下面打标签，当然这里帮你打了。

![image-20230422211207772](image/image-20230422211207772.png)

按照下面，把所有的项目的骨架搭建好。父项目的子项目可能还有子项目，就在里面继续创建module即可。分了三层。

`wcx-dongbao-oms-api`就是一个jar，它会编译成一个jar包，让别的模块来引用。也就是`wcx-dongbao-oms-api`编译之后会变成`wcx-dongbao-oms-api.jar`，别的项目A要用就在A项目的pom文件中写上`wcx-dongbao-oms-api.jar`的坐标，坐标就是`<artifactId> + <GroupId> + <version>`。

一二层都是pom，一二层的模块建起来之后src都要删掉。只有第三层才不删，第三层才是写代码的地方。

建立这么多的module，是为了把模块分开。两个业务模块在两个工程中开发会更好的协作，更能提交的时候减少代码的冲突。以后拆服务、要向微服务进化的时候，模块可以直接独立出去就是一个微服务了。这样的项目重构的话，搞上注册中心，瞬间就变成了微服务了。

- 接口最好不用可变参数例如`String ... age 以及 HashMap`，因为你的接口不可控，别人什么都可以传。

- API就是一个service的规范

- maven子项目继承父项目的版本，如果子项目没有指定版本，那么版本会以父项目的为准，如果指定了，那么就会覆盖父项目。同理，配置`<properties>`也是先继承，如果需要子项目也可以覆盖。

  关于maven加速，找到下面这个settings.xml，然后在文件里面取消掉原本的镜像，加上下面的镜像进行加速。localRepository这个标签也可以改一下，这是下载的包存放的位置。

  ![image-20230510170742156](image/image-20230510170742156.png)

  在Maven中，中央仓库是默认的仓库，它包含了许多常用的依赖库。当Maven需要从中央仓库下载依赖库的jar包等文件时，就会使用这个配置定义的镜像地址进行下载，加快下载速度。

  因此，这个配置项`<mirrorOf>central</mirrorOf>`的作用就是将所有对中央仓库的请求都转发到该镜像地址。中央仓库是默认，下面的仓库是补充，如果中央仓库找不到就会去下面找。

  ```
  	 <localRepository>D:\message\MvnJar</localRepository>
  	  
  	 <mirror> 
        <id>alimaven</id>
        <name>aliyun maven</name>
        <url>http://maven.aliyun.com/nexus/content/groups/public/</url>
        <mirrorOf>central</mirrorOf>     //中央仓库   
      </mirror>	  
      //下面仓库作为补充
  	<mirror>
       <id>aliyunmaven</id>
       <mirrorOf>*</mirrorOf>
       <name>阿里云公共仓库</name>
       <url>https://maven.aliyun.com/repository/public</url>
      </mirror>
       <mirror>
       <id>aliyunmaven</id>
       <mirrorOf>*</mirrorOf>
       <name>阿里云谷歌仓库</name>
       <url>https://maven.aliyun.com/repository/google</url>
      </mirror>
      <mirror>
       <id>aliyunmaven</id>
       <mirrorOf>*</mirrorOf>
       <name>阿里云阿帕奇仓库</name>
       <url>https://maven.aliyun.com/repository/apache-snapshots</url>
      </mirror>
      <mirror>
       <id>aliyunmaven</id>
       <mirrorOf>*</mirrorOf>
       <name>阿里云spring仓库</name>
       <url>https://maven.aliyun.com/repository/spring</url>
      </mirror>
      <mirror>
       <id>aliyunmaven</id>
       <mirrorOf>*</mirrorOf>
       <name>阿里云spring插件仓库</name>
       <url>https://maven.aliyun.com/repository/spring-plugin</url>
      </mirror>
  ```

- maven的另一个好处是一个项目下可以加入工程，也就是模块。并且不需要自己拷贝jar包到lib里面，maven会帮我们自动导入。

- common层里面是一些基础的工具类，比如说有统一封装返回值的一个类。一般的接口的返回值是这样子的，基础common层里封装的就是下面这些，因为这些是每个接口都需要的。

  ```
  {
  	code:1
  	msg:success
  	data:{}
  }
  ```

  

```
代码模块介绍
wcx-dongbao-mall-parent        	父项目
	wcx-dongbao-common 公共包
		wcx-dongbao-common-base 公共基础类
		wcx-dongbao-common-util 工具类，日期转格式、时间转格式等等
	wcx-dongbao-api 业务模块接口层，里面全都是接口，下面的子工程里面定义的全都是interface
		wcx-dongbao-oms-api 订单中心接口
		wcx-dongbao-pms-api 商品中心接口
		wcx-dongbao-ums-api 用户中心接口
		wcx-dongbao-pay-api 支付中心接口
		wcx-dongbao-cart-api 购物车接口
		wcx-dongbao-dictionary-api 基础字典接口
		wcx-dongbao-sms-api 优惠中心接口
		wcx-dongbao-cms-api 内容中心接口
	wcx-dongbao-service 业务模块实现层，是上面api接口层的具体实现。
		wcx-dongbao-oms 订单中心模块实现
		wcx-dongbao-pms 商品中心模块实现
		wcx-dongbao-ums 用户中心模块实现
		wcx-dongbao-pay 支付中心模块实现
		wcx-dongbao-cart 购物车模块实现
		wcx-dongbao-dictionary 基础字典模块实现
		wcx-dongbao-sms 优惠中心模块实现
		wcx-dongbao-cms 内容中心模块实现
	wcx-dongbao-application 是web应用模块，应用的入口-Controller，接住用户的http请求
	    wcx-dongbao-manager-web 后台管理应用
		wcx-dongbao-portal-web 商城门户网站，是外面来调用我们项目的入口
	wcx-dongbao-job 定时任务模块
	wcx-dongbao-generator 代码生成器，MyBatis Plus
```

直接在父项目里面打一个`<modules>`标签，然后在里面直接写上所有需要的模块，然后按`ALT+ENTER`让maven帮你创建，配合`CTRL+ALT+(左 右)`快速返回。

![image-20230510162346318](image/image-20230510162346318.png)

### 装好数据库

1. 去官网：[MySQL :: Download MySQL Community Server](https://dev.mysql.com/downloads/mysql/)

2. 选择linux通用版本：Linux-Gernic，glibc，x86 - 64bit 。

3. 可以在windows下载完用FTP传上去，也可以用wget命令下载，安装到 /usr/local 目录下，解压

```bash
tar -Jxvf 可以解压tar.xz后缀的压缩文件
tar -zxvf 可以解压tar.gz后缀的压缩文件
tar -xvf 可以根据默认后缀帮你决定使用哪种格式进行解压，不知道的时候就用这个

在Linux中，tar命令默认使用gzip进行压缩和解压缩操作，因为gzip是最常见的压缩格式之一。但是使用的tar包是使用xz格式进行压缩的，那么tar命令将自动使用xz进行解压缩。
```

4. 解压完了之后进入到目录里面创建data目录。看你要不要创建mysql组，然后更改权限

```bash
groupadd mysql
useradd -g mysql root
chown -R mysql.mysql '安装目录全路径'
```

5. 创建/etc/my.cnf

```bash
[mysqld]
user=root  以root的身份启动mysql服务器
#user=mysql  觉得root启动权利太大了，可以用mysql的身份启动
datadir=/usr/local/mysql/mysql-8.0.30-el7-x86_64/data/  数据防止的目录
basedir=/usr/local/mysql/mysql-8.0.30-el7-x86_64/    安装目录
port=3306  服务器监听的端口
max_connections=200 最大并发连接数
max_connect_errors=10 在尝试连接到MySQL服务器时允许的最大错误数
character-set-server=utf8 默认字符集
default-storage-engine=INNODB 默认存储引擎
default_authentication_plugin=mysql_native_password 指定MySQL服务器使用的默认身份验证插件
lower_case_table_names=1 指定MySQL服务器在创建和查询表时是否将表名转换为小写
group_concat_max_len=102400 指定MySQL服务器允许的最大GROUP_CONCAT()函数返回值的长度
wait_timeout=86400 指定MySQL服务器在等待客户端活动超时之前的最大时间（以秒为单位）
bind-address=0.0.0.0 允许远程
#skip-ssl

[mysql]
default-character-set=utf8

[client]
port=3306  //作为客户端的时候，没有指定去那个端口访问时候的默认访问端口。
default-character-set=utf8
```

5. 进入到bin目录，开始初始化

```bash
.\mysqld --defaults-file="/etc/my.cnf" --initialize --console

--initialize：初始化data目录，数据，密码
--console 打印出来
--defaults-file 指定配置文件路径
```

6. 添加到Linux服务

```
vim /etc/systemd/system/mysql.service
```

加入以下内容

```bash
[Unit]
Description=mysql

[Service]
ExecStart=/usr/local/mysql/mysql-8.0.30-el7-x86_64/bin/mysqld --defaults-file=/etc/my.cnf
ExecStop=/usr/local/mysql/mysql-8.0.30-el7-x86_64/support-files/mysql.server stop
Type=simple

[Install]
WantedBy=multi-user.target
```

刷新，启动！

```bash
systemctl daemon-reload
systemctl start myslq
systemctl status myslq
//systemctl stop myslq
```

7. 登录，改密码，改远程连接的主机为%。

```
mysql -u root -h localhost -p
*****输入密码
ALTER USER 'root'@'localhost' IDENTIFIED WITH mysql_native_password BY 'YYcx2928999.';
use mysql;
update user set host='%' where user='root';
flush privileges;
quit;
```

8. 云服务器开放端口3306



### 创建数据库

根据前端看看开发需要一些什么东西。短信运营商提供的是API。

| <img src="image/image-20230515144351776.png" alt="image-20230515144351776" style="zoom: 50%;" /> | <img src="image/image-20230515144945232.png" alt="image-20230515144945232" style="zoom:50%;" /> |
| ------------------------------------------------------------ | ------------------------------------------------------------ |
| <img src="image/image-20230515145115113.png" alt="image-20230515145115113" style="zoom:50%;" /> |                                                              |

几个字段：用户名，邮箱，密码。**根据这些设计字段，去建表，看建表规约！**

写SQL，该表名为 `ums_member`，包含了一些列的字段，其中的字段及其含义如下：

- `id`: bigint 类型，自增主键，每个记录的唯一标识。
- `username`: varchar(64) 类型，用户名，最长 64 个字符。
- `password`: varchar(64) 类型，密码，最长 64 个字符。
- `icon`: varchar(500) 类型，头像图片的 URL 地址，最长 500 个字符。
- `email`: varchar(100) 类型，电子邮箱地址，最长 100 个字符。
- `nick_name`: varchar(200) 类型，用户昵称，最长 200 个字符。
- `note`: varchar(500) 类型，备注信息，最长 500 个字符。
- `create_time`: datetime 类型，创建时间，记录该条记录创建的时间。
- `login_time`: datetime 类型，最后登录时间，记录用户最近一次登录的时间。
- `status`: int(1) 类型，帐号启用状态，取值为 0 或 1，其中 0 表示禁用，1 表示启用。

该表的主键是 `id` 字段，使用了自增的方式生成每个记录的唯一标识。同时，该表还定义了一个唯一索引，索引名为 `un_name`，作用在 `username` 字段上，使用了 B-TREE 索引算法，保证了 `username` 字段的唯一性，避免了重复的记录。最后，该表使用了 InnoDB 存储引擎，并设置了自增起始值为 61，字符集为 utf8，注释为“后台用户表”。

```SQL
CREATE TABLE `ums_member` (
  `id` bigint(20) NOT NULL AUTO_INCREMENT,
  `username` varchar(64) DEFAULT NULL,
  `password` varchar(64) DEFAULT NULL,
  `icon` varchar(500) DEFAULT NULL COMMENT '头像',
  `email` varchar(100) DEFAULT NULL COMMENT '邮箱',
  `nick_name` varchar(200) DEFAULT NULL COMMENT '昵称',
  `note` varchar(500) DEFAULT NULL COMMENT '备注信息',
  `create_time` datetime DEFAULT NULL COMMENT '创建时间',
  `login_time` datetime DEFAULT NULL COMMENT '最后登录时间',
  `status` int(1) DEFAULT '1' COMMENT '帐号启用状态：0->禁用；1->启用',
  PRIMARY KEY (`id`),
  UNIQUE KEY `un_name` (`username`) USING BTREE COMMENT '用户名唯一'
) ENGINE=InnoDB AUTO_INCREMENT=61 DEFAULT CHARSET=utf8 COMMENT='后台用户表';
```

```
当设计关系型数据库时，我们需要考虑如何组织数据以便于查询和维护。范式（Normalization）就是一种常用的设计数据库的方法，目的是消除冗余数据，使数据库更加简洁、规范和高效。下面是对第一范式、第二范式、第三范式和 BC 范式的直白简单的解释：

第一范式（1NF）：要求数据库中的每个属性都是原子性的，即每个属性不可再分解。例如，如果一个学生表包含一个名字字段和一个地址字段，而地址字段包含了多个子属性（如街道、城市、省份等），那么这个表就不符合第一范式。

第二范式（2NF）：要求数据库中的每个非主键属性都完全依赖于主键，而不是仅依赖于主键的部分属性。例如，如果一个订单表包含订单号、商品编号、商品名称和商品单价等属性，那么商品名称和商品单价就不符合第二范式，因为它们仅依赖于商品编号，而不是订单号和商品编号的组合。

第三范式（3NF）：要求数据库中的每个非主键属性都不依赖于其他非主键属性，即不存在传递依赖关系。例如，如果一个部门表包含部门编号、部门名称和部门负责人等属性，其中部门负责人又包含多个子属性（如姓名、电话、邮箱等），那么这个表就不符合第三范式，因为部门负责人的姓名、电话和邮箱等属性都依赖于部门负责人这个属性，而不是部门编号或部门名称。

BC 范式：BC 范式是基于多值依赖的范式，要求数据库中的每个属性都完全依赖于主键，而不是仅依赖于主键的某一部分。这个范式比第三范式更加严格，可以进一步消除冗余数据，提高数据库的性能和可维护性。但是，实际上很少有数据库设计达到 BC 范式，因为它要求的条件比较苛刻，且设计成本较高。

总之，范式是一种规范化的数据库设计方法，可以提高数据库的可靠性、可维护性和性能。但是，应该根据具体的应用场景和需求来选择合适的范式，并且在设计时需权衡范式要求和实际情况之间的差异。
```

```
UNIQUE KEY `un_name` (`username`) USING BTREE COMMENT '用户名唯一'

这是一段 MySQL 数据库表定义语句中的一个索引定义语句，它定义了一个名为 un_name 的唯一索引，该索引作用在 username 字段上，使用了 B-TREE 索引算法，同时添加了注释说明“用户名唯一”。

唯一索引是一种索引类型，它要求表中对应字段的值必须唯一，即不能重复，这可以保证数据库表中不会出现重复数据。在这个例子中，un_name 索引作用在 username 字段上，因此数据库会自动检查 username 字段的值是否唯一，如果不唯一，则会抛出异常，避免插入重复数据。

B-TREE 索引是一种常见的索引算法，它将数据存储在一棵 B-TREE 数据结构中，可以高效地支持范围查询和排序操作。在这个例子中，使用 B-TREE 索引算法可以提高 username 字段的查询效率，加快数据库的响应速度。

注释是可选的，可以用来说明索引的作用和用途，便于开发人员理解和维护数据库。在这个例子中，注释说明了这个索引的作用是保证 username 字段的唯一性。
```

